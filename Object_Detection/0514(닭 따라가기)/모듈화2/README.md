# 닭 객체 추적 시스템

## 프로젝트 개요
이 프로젝트는 딥러닝 기반의 닭 객체 추적 시스템으로, 영상에서 닭을 감지하고 지속적으로 추적하는 기능을 제공합니다. 화면을 그리드로 분할하여 특정 영역을 확대해서 볼 수 있고, 각 닭의 ID를 일관되게 유지하는 고성능 알고리즘을 구현했습니다. 최근 최적화를 통해 계산 효율성과 추적 정확도가 크게 향상되었습니다.

## 파일 구조 및 역할

### 1. main.py
메인 실행 파일로 비디오 플레이어를 초기화하고 실행합니다.
- 비디오 경로와 모델 경로를 설정
- 3x3 그리드와 0.5 배율로 VideoPlayer 객체 생성 및 실행

```python
# 실행 예시
player = VideoPlayer(video_path, model_path, grid_size=3, scale_factor=0.5)
player.play()
```

### 2. VideoPlayer.py
비디오 재생 및 그리드 분할, 사용자 인터랙션을 담당합니다.
- 그리드 분할 시각화 및 키보드 단축키 제어
- 마우스 클릭으로 특정 그리드 셀 선택 및 확대
- 객체 추적 ID 시각화 및 상태 정보 표시

주요 메서드:
- `play()`: 비디오 재생 및 이벤트 루프 처리
- `initialize_video()`: 비디오 파일 열기 및 초기화
- `_draw_id_text_with_background()`: ID 텍스트를 배경과 함께 그리는 함수
- `_get_id_set_for_detection()`: 객체의 ID 집합 조회 함수

### 3. ChickenDetector.py
YOLO 모델을 사용하여 닭을 감지하고 추적하는 알고리즘을 구현합니다.

#### 주요 기능:
- YOLO 모델을 사용한 닭 객체 탐지
- 객체 추적 알고리즘으로 ID 일관성 유지
- 객체가 잠시 사라졌다가 다시 나타나도 같은 ID로 식별

#### ID 관리 시스템:
- **데이터 구조:**
  - `chicken_id_sets`: 같은 닭으로 판단된 ID의 집합들 리스트
  - `id_to_set_index`: ID가 어느 집합에 속하는지 매핑하는 딕셔너리
  - `id_to_position`: ID별 위치 정보 (중심 좌표) 저장
  - `id_to_last_frame`: 각 ID가 마지막으로 등장한 프레임 번호
  - `id_to_last_time`: 각 ID가 마지막으로 등장한 시간
  - `set_to_display_id`: 각 ID 집합의 대표 ID (보통 가장 작은 ID 값)

#### 최적화된 객체 추적 알고리즘:
- **최근 사라진 ID 필터링**: 모든 ID를 비교하는 대신 시간 임계값 내에 사라진 ID만 검색
- **제곱 거리 계산**: `sqrt` 연산 제거로 계산 효율성 향상
  ```python
  # Euclidean 대신 제곱 거리 사용
  distance_squared = (center[0] - old_pos[0])**2 + (center[1] - old_pos[1])**2
  ```
- **매칭 점수 시스템**: 거리와 시간을 함께 고려한 복합 점수 사용
  ```python
  match_score = distance_squared + (time_diff * 10)  # 시간 가중치 추가
  ```
- **배치 처리**: 매칭되지 않은 새 ID들을 일괄 처리
- **지역 변수 캐싱**: 자주 사용하는 데이터 구조를 지역 변수로 캐싱
- **효율적 데이터 관리**: 100프레임마다 오래된 데이터 정리

### 4. TextRenderer.py
한글 텍스트를 이미지에 렌더링하는 기능을 제공합니다.
- PIL 라이브러리를 사용한 한글 텍스트 렌더링
- 배경이 있는 텍스트 표시 옵션
- 다양한 PIL 버전에 대한 호환성 지원

## 사용 방법
1. `main.py` 실행
2. 키보드 단축키:
   - `q`: 종료
   - `g`: 그리드 모드/확대 모드 전환
   - `+/-`: 확대/축소
   - `y`: YOLO 탐지 켜기/끄기
   - `t`: 객체 추적(ID 표시) 켜기/끄기
   - `c`: 일관된 ID 추적 켜기/끄기
   - `[/]`: 탐지 임계값 조절
   - `1/2`: 탐지 간격 감소/증가
   - 스페이스바: 재생/일시정지
   - `a/d`: 뒤로/앞으로 5초
   - 마우스 클릭: 그리드 칸 선택/확대

## 성능 고려사항
- 거리 임계값(`distance_threshold`): 같은 객체로 판단할 최대 거리 (현재 25)
- 시간 임계값(`time_threshold`): 같은 객체로 판단할 최대 시간 차이 (현재 1.5초)
- 데이터 정리 주기: 100프레임마다 오래된 추적 데이터 정리

## 기술적 세부사항

### ID 일관성 유지 알고리즘
1. 각 프레임에서 감지된 객체의 중심 위치 계산
2. 현재 프레임에 없지만 최근에 사라진 ID 식별 (시간 임계값 내)
3. 새로운 ID와 최근에 사라진 ID 간의 거리 계산
4. 거리와 시간 차이를 고려한 매칭 점수로 최적의 매칭 찾기
5. 매칭된 ID들은 같은 집합에 포함되어 같은 닭으로 인식

예시: `chicken_id_sets = [{1, 5, 7}, {2, 8}, {3, 4, 9}]`는 세 마리의 닭을 의미합니다:
- 첫 번째 닭은 ID 1, 5, 7로 탐지됨
- 두 번째 닭은 ID 2, 8로 탐지됨
- 세 번째 닭은 ID 3, 4, 9로 탐지됨

디스플레이에는 각 집합의 대표 ID(일반적으로 가장 작은 값)가 표시됩니다.
