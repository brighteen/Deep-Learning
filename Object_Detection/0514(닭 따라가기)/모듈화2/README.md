# 닭 객체 추적 시스템

## 프로젝트 개요
이 프로젝트는 딥러닝 기반의 닭 객체 추적 시스템으로, 영상에서 닭을 감지하고 지속적으로 추적하는 기능을 제공합니다. 화면을 그리드로 분할하여 특정 영역을 확대해서 볼 수 있고, 각 닭의 ID를 일관되게 유지하는 고성능 알고리즘을 구현했습니다. 최근 최적화를 통해 계산 효율성과 추적 정확도가 크게 향상되었습니다.

## 구성 요소

### 1. main.py
메인 실행 파일로 비디오 플레이어를 초기화하고 실행합니다.
- 비디오 경로와 모델 경로를 설정
- 3x3 그리드와 0.5 배율로 VideoPlayer 객체 생성 및 실행

### 2. VideoPlayer.py
비디오 재생 및 그리드 분할, 사용자 인터랙션을 담당합니다.
- 그리드 분할 시각화 (3x3 그리드)
- 키보드 단축키로 다양한 기능 제어 (재생/일시정지, 그리드/확대 모드 전환 등)
- 마우스 클릭으로 특정 그리드 셀 선택 및 확대
- 객체 추적 ID 시각화 개선 (배경 추가, ID 세트 명확하게 표시)
- 상태 정보 표시 (배율, 시간, 탐지된 닭 수, 모드 등)

주요 헬퍼 메서드:
- `_get_id_set_for_detection()`: 객체의 ID 세트를 일관성 있게 가져오는 함수
- `_draw_id_text_with_background()`: ID 텍스트를 배경과 함께 그리는 함수

### 3. ChickenDetector.py
YOLO 모델을 사용하여 닭을 감지하고 추적하는 알고리즘을 구현합니다.
- YOLO 모델을 사용한 닭 객체 탐지
- 객체 추적 알고리즘으로 ID 일관성 유지
- 객체가 잠시 사라졌다가 다시 나타나도 같은 ID로 식별

최적화된 객체 추적 알고리즘:
- **최근 사라진 ID만 검색**: 모든 ID를 비교하는 대신 시간 임계값 내에 사라진 ID만 검색하여 연산량 감소
- **제곱 거리 계산**: sqrt 연산 제거로 계산 효율성 향상
- **시간 가중치 적용**: 거리와 시간을 함께 고려한 매칭 점수 사용으로 매칭 품질 향상
- **배치 처리**: 매칭되지 않은 새 ID들을 일괄 처리하여 반복 루프 최소화
- **지역 변수 캐싱**: 자주 사용하는 데이터 구조를 지역 변수로 캐싱하여 속성 접근 최소화
- **불필요한 연산 제거**: 오래된 데이터가 없을 때 빠른 반환, 영향받은 집합만 확인 등

### 4. TextRenderer.py
한글 텍스트를 이미지에 렌더링하는 기능을 제공합니다.
- PIL 라이브러리를 사용한 한글 텍스트 렌더링
- 배경이 있는 텍스트 표시 옵션
- 다양한 PIL 버전에 대한 호환성 지원

## 사용 방법
1. main.py 실행
2. 키보드 단축키:
   - 'q': 종료
   - 'g': 그리드 모드/확대 모드 전환
   - '+/-': 확대/축소
   - 'y': YOLO 탐지 켜기/끄기
   - 't': 객체 추적(ID 표시) 켜기/끄기
   - 'c': 일관된 ID 추적 켜기/끄기
   - '[/]': 탐지 임계값 조절
   - '1'/'2': 탐지 간격 감소/증가
   - 스페이스바: 재생/일시정지
   - 'a'/'d': 뒤로/앞으로 5초
3. 마우스로 그리드 칸을 클릭하여 해당 영역 확대

## 개선사항
- 거리 임계값 최적화 (50px → 25px)
- 시간 임계값 최적화 (2.0초 → 1.5초)  
- 객체 ID 시각화 개선 (배경 추가, 정렬된 ID 세트)
- 그리드 크기 최적화 (5x5 → 3x3)
- ID 매칭 알고리즘 개선으로 객체 식별 정확도 향상

## 버그 수정
- ChickenDetector 클래스의 `use_consistent_ids` 속성 초기화 문제 수정
  - 줄 바꿈 문제로 인해 속성이 제대로 초기화되지 않아 오류가 발생하던 문제 해결

## 최신 업데이트
- ID 표시 방식 개선 (2025.05.14)
  - 고유 ID와 관련 ID를 집합 형식으로 표시 ("고유ID {고유ID와 추가로 할당된 ID 목록}")
  - 고유 ID를 집합 내 가장 앞에 표시하여 식별 용이성 향상
  - 단일 ID의 경우에도 일관된 형식으로 표시 ("고유ID N: {N}")
  - 모든 관련 ID를 한 줄에 집합 형태로 표시하여 시각적 통일성 확보

## 성능 분석: 집합(Set)을 이용한 ID 표현의 계산 비용
객체 추적 시스템에서 동일 객체의 ID를 집합(set)으로 표현할 때 발생하는 계산 비용은 다음과 같습니다:

### 공간 복잡도
- **ID 집합 저장**: O(N), N은 시스템이 추적하는 총 ID 수
- **ID 매핑 테이블**: O(N), ID를 집합 인덱스로 매핑하는 데 필요한 공간
- **실제 메모리 사용량**: 일반적으로 수백 개의 ID를 추적하는 경우에도 수 KB 수준으로 매우 낮음

### 시간 복잡도
- **ID 검색**: O(1), 해시 테이블 기반 집합 구현으로 상수 시간 검색
- **ID 집합 병합**: O(N), N은 병합할 집합의 요소 수
- **ID 매칭 알고리즘**: O(M * log M), M은 현재 프레임에서 탐지된 객체 수 (거리 기준 정렬 때문)

### 실시간 성능 영향
- **프레임당 처리 오버헤드**: 일반적으로 1ms 미만 (객체 수가 10~20개인 경우)
- **탐지 알고리즘 대비 비중**: YOLO 모델의 추론 시간(30~50ms)에 비해 ID 집합 관리 비용(1~2ms)은 매우 낮음
- **병목 지점**: ID 집합 관리가 아닌 객체 탐지 모델이 주요 병목 지점

### 최적화 고려사항
1. **주기적인 정리**: 100프레임마다 오래된 ID 정리로 메모리 관리
2. **임계값 조정**: 거리(25px) 및 시간(1.5초) 임계값 최적화로 불필요한 집합 병합 방지
3. **중복 매칭 방지**: 이미 매칭된 ID를 추적하여 계산 낭비 방지
